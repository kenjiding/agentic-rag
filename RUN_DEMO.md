# ç¡®è®¤æœºåˆ¶æ¼”ç¤ºæŒ‡å—

## åŠŸèƒ½è¯´æ˜

ç¡®è®¤æœºåˆ¶æ”¯æŒä¸¤ç§ç¡®è®¤æ–¹å¼ï¼š
1. **UI æŒ‰é’®ç¡®è®¤**ï¼šç”¨æˆ·ç‚¹å‡»å‰ç«¯çš„"ç¡®è®¤"æˆ–"å–æ¶ˆ"æŒ‰é’®
2. **æ–‡æœ¬ç¡®è®¤**ï¼šç”¨æˆ·é€šè¿‡è¾“å…¥"ç¡®è®¤"ã€"æ˜¯"ã€"å¥½çš„"ç­‰å…³é”®è¯ç¡®è®¤

## å‰ç«¯ UI ç‰¹æ€§

### ConfirmationDialog ç»„ä»¶ç‰¹æ€§ï¼š
- ğŸ¨ ç²¾ç¾çš„ç¥ç€è‰²ä¸»é¢˜å¡ç‰‡è®¾è®¡  - ğŸ›ï¸ è®¢å•å•†å“æ˜ç»†å±•ç¤ºï¼ˆå•†å“åˆ—è¡¨ã€å•ä»·ã€å°è®¡ã€æ€»é‡‘é¢ï¼‰
- âœ… ç¡®è®¤æŒ‰é’®ï¼ˆç»¿è‰²ï¼Œå¸¦å›¾æ ‡ï¼‰
- âŒ å–æ¶ˆæŒ‰é’®ï¼ˆç°è‰²ï¼Œå¸¦å›¾æ ‡ï¼‰
- â³ åŠ è½½çŠ¶æ€åŠ¨ç”»
- ğŸ“± å“åº”å¼è®¾è®¡

### ç¡®è®¤å¯¹è¯æ¡†æ¸²æŸ“ä½ç½®ï¼š
`MessageList` ç»„ä»¶ä¼šåœ¨æ£€æµ‹åˆ°æ¶ˆæ¯åŒ…å« `confirmationPending` æ—¶è‡ªåŠ¨æ¸²æŸ“ç¡®è®¤å¯¹è¯æ¡†ã€‚

## æµ‹è¯•æ­¥éª¤

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ UI æŒ‰é’®ç¡®è®¤ï¼ˆæ¨èï¼‰

1. å¯åŠ¨åç«¯æœåŠ¡ï¼š
   ```bash
   uvicorn src.api.server:app --reload --host 0.0.0.0 --port 8000
   ```

2. å¯åŠ¨å‰ç«¯æœåŠ¡ï¼š
   ```bash
   cd front-chat
   npm run dev
   ```

3. åœ¨èŠå¤©ç•Œé¢è¾“å…¥ï¼š
   ```
   æˆ‘çš„æ‰‹æœºå·æ˜¯ 13800138000ï¼Œå¸®æˆ‘æŸ¥è¯¢è®¢å•
   ```

4. é€‰æ‹©ä¸€ä¸ªè®¢å•åï¼Œè¾“å…¥ï¼š
   ```
   å–æ¶ˆè®¢å• 1
   ```

5. æ­¤æ—¶ä¼šå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œç‚¹å‡»"ç¡®è®¤"æˆ–"å–æ¶ˆ"æŒ‰é’®

### æ–¹å¼äºŒï¼šä½¿ç”¨æ–‡æœ¬ç¡®è®¤

1. æŒ‰ç…§æ–¹å¼ä¸€çš„æ­¥éª¤ 1-4

2. å½“å‡ºç°ç¡®è®¤å¯¹è¯æ¡†æ—¶ï¼Œä¸ç‚¹å‡»æŒ‰é’®ï¼Œè€Œæ˜¯åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ï¼š
   ```
   ç¡®è®¤
   ```
   æˆ–
   ```
   æ˜¯
   ```
   æˆ–
   ```
   å¥½çš„
   ```

3. ç³»ç»Ÿä¼šæ‰§è¡Œç¡®è®¤æ“ä½œå¹¶è¿”å›ç»“æœ

## ç¡®è®¤æœºåˆ¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¾“å…¥   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   å›¾æ‰§è¡Œ          â”‚
â”‚  "å–æ¶ˆè®¢å•" â”‚          â”‚  (ainvoke)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  v
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Order Agent    â”‚
                         â”‚ prepare_cancel   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  v
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ConfirmationManager        â”‚
                    â”‚  request_confirmation()     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                   â”‚
                v                                   v
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  å‰ç«¯æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†  â”‚           â”‚  InMemoryStorage     â”‚
      â”‚  ConfirmationDialogâ”‚           â”‚  (è·¨è¯·æ±‚æŒä¹…åŒ–)       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
      â”‚                    â”‚                       â”‚
      v                    v                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚UI æŒ‰é’®ç¡®è®¤â”‚        â”‚æ–‡æœ¬è¾“å…¥ç¡®è®¤â”‚         â”‚session_id ç´¢å¼•  â”‚
â”‚è°ƒç”¨ API  â”‚        â”‚ä¸‹æ¬¡è¯·æ±‚æ—¶  â”‚         â”‚æ¯ä¼šè¯ä¸€ä¸ªå¾…ç¡®è®¤ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           v
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ConfirmationManager       â”‚
              â”‚resolve_confirmation()    â”‚
              â”‚æ‰§è¡Œæ“ä½œï¼Œè¿”å›ç»“æœ         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API ç«¯ç‚¹

### ç¡®è®¤è§£æ
- **ç«¯ç‚¹**: `POST /api/confirmation/resolve`
- **è¯·æ±‚ä½“**:
  ```json
  {
    "confirmation_id": "uuid",
    "confirmed": true  // or false
  }
  ```
- **å“åº”**:
  ```json
  {
    "success": true,
    "status": "confirmed",
    "action_type": "cancel_order",
    "message": "è®¢å•å–æ¶ˆæˆåŠŸ",
    "data": {...}
  }
  ```

### è·å–å¾…ç¡®è®¤æ“ä½œ
- **ç«¯ç‚¹**: `GET /api/confirmation/pending/{session_id}`
- **å“åº”**:
  ```json
  {
    "has_pending": true,
    "confirmation": {
      "confirmation_id": "uuid",
      "action_type": "cancel_order",
      "display_message": "ç¡®è®¤å–æ¶ˆè®¢å•",
      "display_data": {...}
    }
  }
  ```

## æ–‡ä»¶ç»“æ„

### åç«¯
- `src/confirmation/` - ç¡®è®¤æœºåˆ¶æ ¸å¿ƒæ¨¡å—
  - `models.py` - æ•°æ®æ¨¡å‹
  - `storage.py` - å­˜å‚¨å®ç°
  - `manager.py` - ç®¡ç†å™¨
  - `exceptions.py` - å¼‚å¸¸å®šä¹‰

- `src/api/server.py` - API ç«¯ç‚¹å’Œæ‰§è¡Œå™¨æ³¨å†Œ
- `src/multi_agent/agents/order_agent.py` - Order Agent é›†æˆ
- `src/multi_agent/graph.py` - å›¾æ‰§è¡Œï¼ˆä¼ é€’ session_idï¼‰

### å‰ç«¯
- `front-chat/src/components/chat/ConfirmationDialog.tsx` - ç¡®è®¤å¯¹è¯æ¡†ç»„ä»¶
- `front-chat/src/hooks/useStreamingChat.ts` - èŠå¤©é€»è¾‘ï¼ˆåŒ…å«ç¡®è®¤å¤„ç†ï¼‰
- `front-chat/src/components/chat/MessageList.tsx` - æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ¸²æŸ“ç¡®è®¤å¯¹è¯æ¡†ï¼‰
- `front-chat/src/types/index.ts` - TypeScript ç±»å‹å®šä¹‰

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæ–‡æœ¬ç¡®è®¤åæ²¡æœ‰å“åº”ï¼Ÿ

A: è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š
1. LLM æ²¡æœ‰è°ƒç”¨ `prepare_*` å·¥å…· - è¿™æ˜¯ LLM è¡Œä¸ºé—®é¢˜ï¼Œä¸æ˜¯ä»£ç é—®é¢˜
2. å•†å“åº“å­˜ä¸è¶³å¯¼è‡´è®¢å•æ— æ³•åˆ›å»º - ç¡®ä¿æµ‹è¯•æ•°æ®æœ‰åº“å­˜
3. ç¡®è®¤æ“ä½œæ‰§è¡Œå¤±è´¥ - æ£€æŸ¥åç«¯æ—¥å¿—

### Q: å¦‚ä½•è°ƒè¯•ç¡®è®¤æµç¨‹ï¼Ÿ

A:
1. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```bash
   # åç«¯ä¼šè¾“å‡ºè¯¦ç»†çš„ç¡®è®¤è¯·æ±‚åˆ›å»ºå’Œè§£ææ—¥å¿—
   ```

2. ä½¿ç”¨å•å…ƒæµ‹è¯•ï¼š
   ```bash
   uv run python examples/test_confirmation_mechanism.py
   ```

3. æ£€æŸ¥ ConfirmationManager çŠ¶æ€ï¼š
   ```python
   manager = get_confirmation_manager()
   stats = manager._storage.get_stats()  # å†…å­˜å­˜å‚¨çš„ç»Ÿè®¡ä¿¡æ¯
   ```

### Q: ç¡®è®¤å¯¹è¯æ¡†æ²¡æœ‰æ˜¾ç¤ºï¼Ÿ

A: æ£€æŸ¥ï¼š
1. å‰ç«¯æ˜¯å¦æ­£ç¡®æ¥æ”¶åˆ° `confirmation_pending` æ•°æ®
2. `MessageList` æ˜¯å¦æ­£ç¡®ä¼ é€’äº† `onConfirm` å’Œ `onCancel` å›è°ƒ
3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

## ä¸‹ä¸€æ­¥æ”¹è¿›

1. **Redis å­˜å‚¨**ï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
2. **ç¡®è®¤è¶…æ—¶æé†’**ï¼šå‰ç«¯å€’è®¡æ—¶æ˜¾ç¤º
3. **ç¡®è®¤å†å²è®°å½•**ï¼šæ”¯æŒæŸ¥è¯¢å†å²ç¡®è®¤æ“ä½œ
4. **æ‰¹é‡ç¡®è®¤**ï¼šæ”¯æŒä¸€æ¬¡ç¡®è®¤å¤šä¸ªæ“ä½œ
